<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Control de dispositivos a distancia</title>
  </head>
  <body>
    <script>
      // ğŸ”Œ ConexiÃ³n WebSocket
      const socket = new WebSocket(
        "wss://servidor-ws-conexionesp32.onrender.com"
      );

      socket.onopen = () => {
        console.log("âœ… Conectado al servidor WebSocket");
        socket.send(
          JSON.stringify({ type: "hello", msg: "Hola desde el navegador" })
        );
      };

      socket.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          console.log("ğŸ“© Mensaje del servidor:", data);
        } catch (err) {
          console.error("âŒ Error al parsear mensaje:", event.data);
        }
      };

      socket.onclose = () => {
        console.log("ğŸ”Œ ConexiÃ³n cerrada");
      };

      socket.onerror = (error) => {
        console.error("âš ï¸ Error en la conexiÃ³n WebSocket:", error);
      };

      // ğŸ—£ï¸ Reconocimiento de voz
      const recognition = new webkitSpeechRecognition();
      recognition.continuous = true;
      recognition.interimResults = true; // Activamos resultados intermedios
      recognition.lang = "es-ES";

      recognition.onresult = (event) => {
        const result = event.results[event.results.length - 1];

        if (!result.isFinal) return; // Ignorar resultados intermedios

        const transcript = result[0].transcript.trim().toLowerCase();
        console.log("ğŸ—£ï¸ Texto final detectado:", transcript);

        // Regex para capturar comando luego de "alexa"
        const match = transcript.match(/alexa[,:\s]*(.+)/);
        let comando = match?.[1]?.trim().replace(/\.$/, "");

        if (comando) {
          // Eliminar todas las comas
          comando = comando.replace(/,/g, "");

          if (socket.readyState === WebSocket.OPEN) {
            socket.send(comando);
            console.log("ğŸ“¤ Comando enviado:", comando);
          } else {
            console.log("ğŸ”‡ ConexiÃ³n WebSocket no estÃ¡ abierta");
          }
        } else {
          console.log("ğŸ”‡ Ignorado (no se dijo 'alexa' correctamente)");
        }
      };

      recognition.onerror = (event) => {
        console.error("ğŸ¤ Error de reconocimiento:", event.error);
        if (event.error !== "aborted") {
          recognition.start();
        }
      };

      recognition.onend = () => {
        console.log("ğŸ” Reconocimiento detenido. Reiniciando...");
        recognition.start();
      };

      recognition.start();

      // ğŸ‘ï¸ Reiniciar reconocimiento al volver a la pestaÃ±a
      document.addEventListener("visibilitychange", () => {
        if (!document.hidden) {
          console.log("ğŸ‘ï¸ PestaÃ±a activa, reiniciando reconocimiento...");
          recognition.start();
        }
      });
    </script>
  </body>
</html>
